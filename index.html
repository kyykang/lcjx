<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>营销平台流程绩效分析平台</title>
    <script src="chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card h3 {
            font-size: 2em;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
        }
        
        .module {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .module h2 {
            color: #2c3e50;
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2em;
            color: #7f8c8d;
        }
        
        .error {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2em;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>营销平台流程绩效分析平台</h1>
        <p>基于流程效率数据的可视化分析系统</p>
    </div>
    
    <div class="container">
        <!-- 调试信息区域 -->
        <div id="debugInfo" style="background: #f0f0f0; padding: 10px; margin-bottom: 20px; border-radius: 5px; font-family: monospace; font-size: 12px;">
            <strong>调试信息:</strong><br>
            <span id="debugText">页面加载中...</span>
            <br><strong>测试信息:</strong> HTML页面已加载，等待JavaScript执行...
        </div>
        
        <div class="stats-cards" id="statsCards">
            <div class="stat-card">
                <h3 id="totalFlows">-</h3>
                <p>总流程数</p>
            </div>
            <div class="stat-card">
                <h3 id="totalInitiated">-</h3>
                <p>总发起数</p>
            </div>
            <div class="stat-card">
                <h3 id="totalCompleted">-</h3>
                <p>总完成数</p>
            </div>
            <div class="stat-card">
                <h3 id="avgDuration">-</h3>
                <p>平均时长(小时)</p>
            </div>
        </div>
        
        <div class="modules-grid">
            <div class="module">
                <h2>发起流程数及完成数排名</h2>
                <div class="chart-container">
                    <canvas id="flowRankingChart"></canvas>
                </div>
            </div>
            
            <div class="module">
                <h2>流程运行时长排名</h2>
                <div class="chart-container">
                    <canvas id="durationRankingChart"></canvas>
                </div>
            </div>
            
            <div class="module">
                <h2>销售类流程平均运行时长排名</h2>
                <div class="chart-container">
                    <canvas id="salesDurationChart"></canvas>
                </div>
            </div>
            
            <div class="module">
                <h2>采购类流程平均运行时长排名</h2>
                <div class="chart-container">
                    <canvas id="purchaseDurationChart"></canvas>
                </div>
            </div>
            
            <div class="module">
                <h2>项目&产品管理类流程平均运行时长排名</h2>
                <div class="chart-container">
                    <canvas id="projectDurationChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 全局变量
        let chartData = null;
        
        // 调试信息更新函数
        function updateDebugInfo(message) {
            const debugText = document.getElementById('debugText');
            if (debugText) {
                debugText.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
            }
            console.log('DEBUG:', message);
        }
        let charts = {};
        
        // 页面完全加载后初始化
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateDebugInfo('DOM加载完成，开始初始化...');
            
            // 检查Chart.js是否加载
            if (typeof Chart === 'undefined') {
                updateDebugInfo('错误: Chart.js库未加载');
                return;
            }
            updateDebugInfo('Chart.js已加载');
            
            // 立即开始加载数据
            loadData();
        });
        
        // 加载数据
        async function loadData() {
            try {
                updateDebugInfo('正在获取chart_data.json...');
                const response = await fetch('chart_data.json');
                
                updateDebugInfo(`Fetch响应: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                chartData = await response.json();
                
                updateDebugInfo(`数据解析成功: success=${chartData.success}, 流程数据=${chartData.data?.flow_ranking?.length}条`);
                
                if (!chartData.success) {
                    throw new Error(chartData.error || '数据加载失败');
                }
                
                updateDebugInfo('开始初始化图表和统计信息...');
                
                // 初始化所有图表和统计信息
                initializeCharts();
                updateStatistics();
                
                updateDebugInfo('图表初始化完成!');
                
            } catch (error) {
                updateDebugInfo('错误: ' + error.message);
                showErrorState(error.message);
            }
        }
        
        // 显示加载状态
        function showLoadingState() {
            const modules = document.querySelectorAll('.module .chart-container');
            modules.forEach(container => {
                container.innerHTML = '<div class="loading">正在加载数据</div>';
            });
        }
        
        // 清除加载状态
        function clearLoadingState() {
            console.log('清除加载状态...');
            const loadingElements = document.querySelectorAll('.loading');
            console.log('找到的loading元素数量:', loadingElements.length);
            loadingElements.forEach((element, index) => {
                console.log(`清除第${index + 1}个loading元素`);
                element.remove();
            });
        }
        
        // 显示错误状态
        function showErrorState(message) {
            const modules = document.querySelectorAll('.module .chart-container');
            modules.forEach(container => {
                container.innerHTML = `<div class="error">数据加载失败: ${message}</div>`;
            });
        }
        
        // 初始化所有图表
        function initializeCharts() {
            console.log('开始初始化图表...');
            console.log('chartData:', chartData);
            
            try {
                // 清除加载状态
                clearLoadingState();
                
                // 1. 发起流程数及完成数排名
                console.log('创建发起流程数排名图表...');
                createFlowRankingChart();
                
                // 2. 流程运行时长排名
                console.log('创建流程运行时长排名图表...');
                createDurationRankingChart();
                
                // 3. 销售类流程平均运行时长排名
                console.log('创建销售类流程图表...');
                createCategoryDurationChart('销售类流程', 'salesDurationChart');
                
                // 4. 采购类流程平均运行时长排名
                console.log('创建采购类流程图表...');
                createCategoryDurationChart('采购类流程', 'purchaseDurationChart');
                
                // 5. 项目&产品管理类流程平均运行时长排名
                console.log('创建项目管理类流程图表...');
                createCategoryDurationChart('项目&产品管理类流程', 'projectDurationChart');
                
                console.log('所有图表初始化完成');
            } catch (error) {
                console.error('图表初始化失败:', error);
                showErrorState(error.message);
            }
        }
        
        // 创建发起流程数及完成数排名图表
        function createFlowRankingChart() {
            console.log('开始创建发起流程数排名图表...');
            const canvas = document.getElementById('flowRankingChart');
            console.log('flowRankingChart canvas元素:', canvas);
            if (!canvas) {
                console.error('找不到flowRankingChart canvas元素');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const data = chartData.data.flow_ranking;
            
            // 取前10条数据
            const top10Data = data.slice(0, 10);
            
            const labels = top10Data.map(item => item.模板名称);
            const initiatedData = top10Data.map(item => item.发起流程数);
            const completedData = top10Data.map(item => item.完成环比);
            
            charts.flowRanking = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '发起流程数',
                            data: initiatedData,
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '完成流程数',
                            data: completedData,
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        title: {
                            display: true,
                            text: '发起流程数及完成数排名 (前10名)'
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '数量'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '流程名称'
                            }
                        }
                    }
                }
            });
        }
        
        // 创建流程运行时长排名图表
        function createDurationRankingChart() {
            const canvas = document.getElementById('durationRankingChart');
            if (!canvas) {
                console.error('找不到durationRankingChart canvas元素');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const data = chartData.data.duration_ranking;
            
            // 取前10条数据
            const top10Data = data.slice(0, 10);
            
            const labels = top10Data.map(item => item.模板名称);
            const durationData = top10Data.map(item => item.平均运行时长_数值);
            
            charts.durationRanking = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '平均运行时长(小时)',
                        data: durationData,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        title: {
                            display: true,
                            text: '流程运行时长排名 (前10名)'
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '时长(小时)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '流程名称'
                            }
                        }
                    }
                }
            });
        }
        
        // 创建分类流程运行时长图表
        function createCategoryDurationChart(categoryName, canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`找不到${canvasId} canvas元素`);
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const data = chartData.data.category_rankings[categoryName] || [];
            
            // 取前10条数据
            const top10Data = data.slice(0, 10);
            
            const labels = top10Data.map(item => item.模板名称);
            const durationData = top10Data.map(item => item.平均运行时长_数值);
            
            const chartKey = canvasId.replace('Chart', '');
            charts[chartKey] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '平均运行时长(小时)',
                        data: durationData,
                        backgroundColor: 'rgba(153, 102, 255, 0.8)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        title: {
                            display: true,
                            text: `${categoryName}运行时长排名 (前10名)`
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '时长(小时)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '流程名称'
                            }
                        }
                    }
                }
            });
        }
        
        // 更新统计信息
        function updateStatistics() {
            if (!chartData || !chartData.data) return;
            
            const flowData = chartData.data.flow_ranking;
            
            // 计算统计数据
            const totalFlows = flowData.length;
            const totalInitiated = flowData.reduce((sum, item) => sum + item.发起流程数, 0);
            const totalCompleted = flowData.reduce((sum, item) => sum + item.完成环比, 0);
            const avgDuration = (flowData.reduce((sum, item) => sum + item.平均运行时长_数值, 0) / totalFlows).toFixed(1);
            
            // 更新页面显示
            document.getElementById('totalFlows').textContent = totalFlows;
            document.getElementById('totalInitiated').textContent = totalInitiated.toLocaleString();
            document.getElementById('totalCompleted').textContent = totalCompleted.toLocaleString();
            document.getElementById('avgDuration').textContent = avgDuration;
        }
    </script>
</body>
</html>